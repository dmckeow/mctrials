---
title: "Manual curation trials - the lost final TEs"
date: 2025-08-07
execute:
  warning: false
format:
  html:
    self-contained: true
    fig-height: 12
    fig-width: 12
    fig-format: png
    fig-dpi: 300
---


# Comparing results of different TEammo curators
When I did this I found that my curated final libraries where much smaller, ~ 50 %
Though I had in error removed sequences during the final library review, this problem remains
Now we will just focus on one - D.tristis to look at exactly why the two libs are different

## Run BLASTs between curated libraries

```{bash}
conda activate bioinf

# D.planitibia
lib1="data/MCH_output/D.planitibia/NA2/D.planitibia_NA2_curated-TE-library.fa"
lib1_name="dean"
lib2="../../data/final_libraries/D.planitibia/D.planitibia.TE_library.fasta"
lib2_name="marta"
species="D.planitibia"
strain="NA2"
RM2_lib="data/MCH_output/D.planitibia/NA2/NA2-clean_families.fa"
MCH_lib="data/MCH_output/D.planitibia/NA2/curated_sequences_NR.fa"
scripts/lib_compare.sh $lib1 $lib1_name $lib2 $lib2_name $species $strain $RM2_lib $MCH_lib

# D.tristis
lib1="data/MCH_output/D.tristis/nanopore_D2/D.tristis_nanopore_D2_curated-TE-library.fa"
lib1_name="dean"
lib2="../../data/final_libraries/D.tristis/D.tristis.TE_library.fasta"
lib2_name="marta"
species="D.tristis"
strain="nanopore_D2"
RM2_lib="data/MCH_output/D.tristis/nanopore_D2/nanopore_D2-clean_families.fa"
MCH_lib="data/MCH_output/D.tristis/nanopore_D2/curated_sequences_NR.fa"
scripts/lib_compare.sh $lib1 $lib1_name $lib2 $lib2_name $species $strain $RM2_lib $MCH_lib

# D.santomea
lib1="data/MCH_output/D.santomea/STO_CAGO_1482_RefSeq/D.santomea_STO_CAGO_1482_RefSeq_curated-TE-library.fa"
lib1_name="dean"
lib2="../../data/final_libraries/D.santomea/D.santomea.TE_library.fasta"
lib2_name="marta"
species="D.santomea"
strain="STO_CAGO_1482_RefSeq"
RM2_lib="data/MCH_output/D.santomea/STO_CAGO_1482_RefSeq/STO_CAGO_1482_RefSeq-clean_families.fa"
MCH_lib="data/MCH_output/D.santomea/STO_CAGO_1482_RefSeq/curated_sequences_NR.fa"
scripts/lib_compare.sh $lib1 $lib1_name $lib2 $lib2_name $species $strain $RM2_lib $MCH_lib
```



## Load and overall comparisons

```{r}
#| output: false
#setwd("/home/csic/gcy/jgp/extra_storage/dean/mctrials/mctrials")
source("scripts/mccompare_functions.R")


library(plotly)
library(dplyr)
library(ggplot2)
#library(BiocParallel)
library(Biostrings)
library(tidyr)
library(seqinr)
library(patchwork)
library(forcats)
library(gt)
```

```{r}
#| output: false

# Color schemes

palette_seq_match <- c(
  "Missing from query lib" = "black",                     # Clear and bold
  "Missing from subject lib" = "grey50",                  # Distinct but neutral
  "Present, 70" = RColorBrewer::brewer.pal(1, "Greens")[1],  # Light green
  "Present, 80" = RColorBrewer::brewer.pal(2, "Greens")[2],  # Medium green
  "Perfect, 95-100" = RColorBrewer::brewer.pal(3, "Greens")[3]  # Bright green
)

# Load the TE classifications
teClassification <- read.table("orozco_classification-2024_mchelper.csv", sep = ";", header = TRUE)
teClassification <- teClassification %>%
  mutate(AppName = paste(Class, Order, Superfamily, sep ="/") %>% sub("/$", "", .) %>% sub("/$", "", .))
teClassification <- rbind(
  teClassification
  , c("", "Unclassified", "", "Unclassified")
)

# Load libraries to compare

# Drosophila planitibia
lib_Dpla_marta <- teReadLib(
  "../../data/final_libraries/D.planitibia/D.planitibia.TE_library.fasta",
  libIdentifier = "Marta",
  species = "D.planitibia", strain = "NA2")

lib_Dpla_dean <- teReadLib(
  "data/MCH_output/D.planitibia/NA2/D.planitibia_NA2_curated-TE-library.fa",
  libIdentifier = "Dean",
  species = "D.planitibia", strain = "NA2")

lib_Dpla_RM2 <- teReadLib(
  "data/MCH_output/D.planitibia/NA2/NA2-clean_families.fa",
  libIdentifier = "RM2",
  species = "D.planitibia", strain = "NA2")

lib_Dpla_MCH <- teReadLib(
  "data/MCH_output/D.planitibia/NA2/curated_sequences_NR.fa",
  libIdentifier = "MCH",
  species = "D.planitibia", strain = "NA2")

# Drosophila tristis
lib_Dtri_marta <- teReadLib(
  "../../data/final_libraries/D.tristis/D.tristis.TE_library.fasta",
  libIdentifier = "Marta",
  species = "D.tristis", strain = "nanopore_D2")

lib_Dtri_dean <- teReadLib(
  "data/MCH_output/D.tristis/nanopore_D2/D.tristis_nanopore_D2_curated-TE-library.fa",
  libIdentifier = "Dean",
  species = "D.tristis", strain = "nanopore_D2")

lib_Dtri_RM2 <- teReadLib(
  "data/MCH_output/D.tristis/nanopore_D2/nanopore_D2-clean_families.fa",
  libIdentifier = "RM2",
  species = "D.tristis", strain = "nanopore_D2")

lib_Dtri_MCH <- teReadLib(
  "data/MCH_output/D.tristis/nanopore_D2/curated_sequences_NR.fa",
  libIdentifier = "MCH",
  species = "D.tristis", strain = "nanopore_D2")

# Drosophila santomea
lib_Dsan_marta <- teReadLib(
  "../../data/final_libraries/D.santomea/D.santomea.TE_library.fasta",
  libIdentifier = "Marta",
  species = "D.santomea", strain = "STO_CAGO_1482_RefSeq")

lib_Dsan_dean <- teReadLib(
  "data/MCH_output/D.santomea/STO_CAGO_1482_RefSeq/D.santomea_STO_CAGO_1482_RefSeq_curated-TE-library.fa",
  libIdentifier = "Dean",
  species = "D.santomea", strain = "STO_CAGO_1482_RefSeq")

lib_Dsan_RM2 <- teReadLib(
  "data/MCH_output/D.santomea/STO_CAGO_1482_RefSeq/STO_CAGO_1482_RefSeq-clean_families.fa",
  libIdentifier = "RM2",
  species = "D.santomea", strain = "STO_CAGO_1482_RefSeq")

lib_Dsan_MCH <- teReadLib(
  "data/MCH_output/D.santomea/STO_CAGO_1482_RefSeq/curated_sequences_NR.fa",
  libIdentifier = "MCH",
  species = "D.santomea", strain = "STO_CAGO_1482_RefSeq")


```

# Load BLAST results


```{r}

# D.planitibia
blast_Dpla_dean_vs_marta <- LoadBlastComparison(
  blast_out = "results/lib_compare/D.planitibia_NA2_dean_vs_marta.blast.out",
  blast_query_lib = lib_Dpla_dean,
  blast_subject_lib = lib_Dpla_marta,
  species = "D.planitibia",
  strain = "NA2",
  comparison = "dean_vs_marta")

blast_Dpla_marta_vs_dean <- LoadBlastComparison(
  blast_out = "results/lib_compare/D.planitibia_NA2_marta_vs_dean.blast.out",
  blast_query_lib = lib_Dpla_marta,
  blast_subject_lib = lib_Dpla_dean,
  species = "D.planitibia",
  strain = "NA2",
  comparison = "marta_vs_dean")

# D. tristis
blast_Dtri_dean_vs_marta <- LoadBlastComparison(
  blast_out = "results/lib_compare/D.tristis_nanopore_D2_dean_vs_marta.blast.out",
  blast_query_lib = lib_Dtri_dean,
  blast_subject_lib = lib_Dtri_marta,
  species = "D.tristis",
  strain = "nanopore_D2",
  comparison = "dean_vs_marta")

blast_Dtri_marta_vs_dean <- LoadBlastComparison(
  blast_out = "results/lib_compare/D.tristis_nanopore_D2_marta_vs_dean.blast.out",
  blast_query_lib = lib_Dtri_marta,
  blast_subject_lib = lib_Dtri_dean,
  species = "D.tristis",
  strain = "nanopore_D2",
  comparison = "marta_vs_dean")

# D.santomea
blast_Dsan_dean_vs_marta <- LoadBlastComparison(
  blast_out = "results/lib_compare/D.santomea_STO_CAGO_1482_RefSeq_dean_vs_marta.blast.out",
  blast_query_lib = lib_Dsan_dean,
  blast_subject_lib = lib_Dsan_marta,
  species = "D.santomea",
  strain = "STO_CAGO_1482_RefSeq",
  comparison = "dean_vs_marta")

blast_Dsan_marta_vs_dean <- LoadBlastComparison(
  blast_out = "results/lib_compare/D.santomea_STO_CAGO_1482_RefSeq_marta_vs_dean.blast.out",
  blast_query_lib = lib_Dsan_marta,
  blast_subject_lib = lib_Dsan_dean,
  species = "D.santomea",
  strain = "STO_CAGO_1482_RefSeq",
  comparison = "marta_vs_dean")


```


```{r}
#| fig-height: 12
#| fig-cap: "TE query library (current curator, Dean) vs subject library (previous curator, Marta) by BLASTn hit totals (A), percent by TE classification (B), and by total quantites of TE consensuses missing from the query library (C), also shown as classification None/None/None in A & B. BLASTn hits of TE consensus library categorised by BLAST percent identity (pident): Perfect, 95-100 %; Present 80, 80-94 %; Present 70, 70-79 %; Missing, 69 % > - subdivided by missing from query or subject library"

PlotBlastBarMatches(blast_Dtri_dean_vs_marta)
```

```{r}
#| fig-height: 12
#| fig-cap: "TE query library (current curator, Dean) vs subject library (previous curator, Marta) by BLASTn hit totals (A), percent by TE classification (B), and by total quantites of TE consensuses missing from the query library (C), also shown as classification None/None/None in A & B. BLASTn hits of TE consensus library categorised by BLAST percent identity (pident): Perfect, 95-100 %; Present 80, 80-94 %; Present 70, 70-79 %; Missing, 69 % > - subdivided by missing from query or subject library"

PlotBlastBarMatches(blast_Dsan_dean_vs_marta)
```

```{r}
#| fig-height: 12
#| fig-cap: "TE query library (current curator, Dean) vs subject library (previous curator, Marta) by BLASTn hit totals (A), percent by TE classification (B), and by total quantites of TE consensuses missing from the query library (C), also shown as classification None/None/None in A & B. BLASTn hits of TE consensus library categorised by BLAST percent identity (pident): Perfect, 95-100 %; Present 80, 80-94 %; Present 70, 70-79 %; Missing, 69 % > - subdivided by missing from query or subject library"

PlotBlastBarMatches(blast_Dpla_dean_vs_marta)
```


# Simpler version to pull out seq not shared by library
```{r}
# D.planitibia
blast_Dpla_marta_vs_MCH <- LoadBlastComparison(
  blast_out = "results/lib_compare/D.planitibia_NA2_marta_vs_MCH.blast.out",
  blast_query_lib = lib_Dpla_marta,
  blast_subject_lib = lib_Dpla_MCH,
  species = "D.planitibia",
  strain = "NA2",
  comparison = "marta_vs_MCH")

GetMissingTEs(
  genome_name = "Dpla",
  names_relate_file_Query="data/MCH_output/D.planitibia/NA2/MCH_final/D.planitibia_NA2_TE-names-relation.tsv",
  blast_Genome_Lib1_vs_Lib2 = blast_Dpla_dean_vs_marta,
  blast_Genome_Lib2_vs_Lib1 = blast_Dpla_marta_vs_dean,
  blast_Genome_Lib2_vs_MCH = blast_Dpla_marta_vs_MCH,
  lib1_name = "dean",
  lib2_name = "marta")

# Dtristis
blast_Dtri_marta_vs_MCH <- LoadBlastComparison(
  blast_out = "results/lib_compare/D.tristis_nanopore_D2_marta_vs_MCH.blast.out",
  blast_query_lib = lib_Dtri_marta,
  blast_subject_lib = lib_Dtri_MCH,
  species = "D.tristis",
  strain = "nanopore_D2",
  comparison = "marta_vs_MCH")

GetMissingTEs(
  genome_name = "Dtri",
  names_relate_file_Query="data/MCH_output/D.tristis/nanopore_D2/MCH_final/D.tristis_nanopore_D2_TE-names-relation.tsv",
  blast_Genome_Lib1_vs_Lib2 = blast_Dtri_dean_vs_marta,
  blast_Genome_Lib2_vs_Lib1 = blast_Dtri_marta_vs_dean,
  blast_Genome_Lib2_vs_MCH = blast_Dtri_marta_vs_MCH,
  lib1_name = "dean",
  lib2_name = "marta")

# D.santomea
blast_Dsan_marta_vs_MCH <- LoadBlastComparison(
  blast_out = "results/lib_compare/D.santomea_STO_CAGO_1482_RefSeq_marta_vs_MCH.blast.out",
  blast_query_lib = lib_Dsan_marta,
  blast_subject_lib = lib_Dsan_MCH,
  species = "D.santomea",
  strain = "STO_CAGO_1482_RefSeq",
  comparison = "marta_vs_MCH")

GetMissingTEs(
  genome_name = "Dsan",
  names_relate_file_Query="data/MCH_output/D.santomea/STO_CAGO_1482_RefSeq/MCH_final/D.santomea_STO_CAGO_1482_RefSeq_TE-names-relation.tsv",
  blast_Genome_Lib1_vs_Lib2 = blast_Dsan_dean_vs_marta,
  blast_Genome_Lib2_vs_Lib1 = blast_Dsan_marta_vs_dean,
  blast_Genome_Lib2_vs_MCH = blast_Dsan_marta_vs_MCH,
  lib1_name = "dean",
  lib2_name = "marta")

```

# The fate of the missing TEs
* My final lib was 49 vs Marta's 139 for this genome - of these 90 lost TEs:
  * 60 ended up in teNon80Lib - "complete_non808080.fa"
  * 2 ended up in teStandbyLib - presumably the 707070 bug meant they were not added
  * 28 ended up in teIncompleteModelsLib - "incomplete_non808080.fa"

## All the final lib seqs in Marta library are in the MCHelper library
All 139 have a blast hit 95-100% hit vs the MCHelper library
```{r}
length(lib_Dtri_marta)
length(unique(blast_Dtri_marta_vs_MCH$qseqid))

as.data.frame(table(blast_Dtri_marta_vs_MCH$seq_match))
```

## Did I discard them manually?
* 5 discarded in the first MI - they are in the discarded_sequences.fa so this was my manual inspection
* 28 discarded in the 808080 step
* 9 discarded in the Incomplete module
* 42 in total were discarded, leaving 48 removed somewhere else?

## Total seqs discarded?
* 57 in 808080
* 170 in incomplete
* 67 in first MI


## Curation of the lost seqs quick version
With MCHelper M module, you can just inspect the pdfs of from TEaid without importing in TEammo

```{bash}
genome_name="D.tristis"
workdir="output/quick_lost_check/${genome_name}"
rm -fr ${workdir}
mkdir -p ${workdir}
MCH_lib="data/MCH_output/D.tristis/nanopore_D2/curated_sequences_NR.fa"
genome="data/0_raw/D.tristis/nanopore_D2/D.tristis_nanopore_D2.fasta"
miss_lib1="missing_from_Lib1_dean_Dtri.csv"
miss_lib2="missing_from_Lib2_marta_Dtri.csv"

conda activate bioinf
seqkit grep --threads 4 -n -f ${miss_lib1} $MCH_lib > ${workdir}/missing_from_Lib1_dean.fa
seqkit grep --threads 4 -n -f ${miss_lib2} $MCH_lib > ${workdir}/missing_from_Lib2_marta.fa


conda activate MCHelper

python3 ~/tools/TEammo/mchelper-ats/MCHelper.py \
-r T \
--input_type fasta \
-l ${workdir}/missing_from_Lib1_dean.fa \
-g ${genome} \
-o ${workdir}/missing_from_Lib1_dean \
-t 8 \
-v Y > ${workdir}/mchelper_manual.log

python3 ~/tools/TEammo/mchelper-ats/MCHelper.py \
-r T \
--input_type fasta \
-l ${workdir}/missing_from_Lib2_marta.fa \
-g ${genome} \
-o ${workdir}/missing_from_Lib2_marta \
-t 8 \
-v Y > ${workdir}/mchelper_manual.log
```

```{bash}
genome_name="D.santomea"
workdir="output/quick_lost_check/${genome_name}"
rm -fr ${workdir}
mkdir -p ${workdir}
MCH_lib="data/MCH_output/D.santomea/STO_CAGO_1482_RefSeq/curated_sequences_NR.fa"
genome="data/0_raw/D.santomea/STO_CAGO_1482_RefSeq/D.santomea_STO_CAGO_1482_RefSeq.fasta"
miss_lib1="missing_from_Lib1_dean_Dsan.csv"
miss_lib2="missing_from_Lib2_marta_Dsan.csv"

conda activate bioinf
seqkit grep --threads 4 -n -f ${miss_lib1} $MCH_lib > ${workdir}/missing_from_Lib1_dean.fa
seqkit grep --threads 4 -n -f ${miss_lib2} $MCH_lib > ${workdir}/missing_from_Lib2_marta.fa

conda activate MCHelper
python3 ~/tools/TEammo/mchelper-ats/MCHelper.py \
-r T \
--input_type fasta \
-l ${workdir}/missing_from_Lib1_dean.fa \
-g ${genome} \
-o ${workdir}/missing_from_Lib1_dean \
-t 8 \
-v Y > ${workdir}/mchelper_manual.log

python3 ~/tools/TEammo/mchelper-ats/MCHelper.py \
-r T \
--input_type fasta \
-l ${workdir}/missing_from_Lib2_marta.fa \
-g ${genome} \
-o ${workdir}/missing_from_Lib2_marta \
-t 8 \
-v Y > ${workdir}/mchelper_manual.log
```

```{bash}
genome_name="D.planitibia"
workdir="output/quick_lost_check/${genome_name}"
rm -fr ${workdir}
mkdir -p ${workdir}
MCH_lib="data/MCH_output/D.planitibia/NA2/curated_sequences_NR.fa"
genome="data/0_raw/D.planitibia/NA2/D.planitibia.rm.fasta"
miss_lib1="missing_from_Lib1_dean_Dpla.csv"
miss_lib2="missing_from_Lib2_marta_Dpla.csv"


conda activate bioinf
seqkit grep --threads 4 -n -f ${miss_lib1} $MCH_lib > ${workdir}/missing_from_Lib1_dean.fa
seqkit grep --threads 4 -n -f ${miss_lib2} $MCH_lib > ${workdir}/missing_from_Lib2_marta.fa

conda activate MCHelper
python3 ~/tools/TEammo/mchelper-ats/MCHelper.py \
-r T \
--input_type fasta \
-l ${workdir}/missing_from_Lib1_dean.fa \
-g ${genome} \
-o ${workdir}/missing_from_Lib1_dean \
-t 8 \
-v Y > ${workdir}/mchelper_manual.log

python3 ~/tools/TEammo/mchelper-ats/MCHelper.py \
-r T \
--input_type fasta \
-l ${workdir}/missing_from_Lib2_marta.fa \
-g ${genome} \
-o ${workdir}/missing_from_Lib2_marta \
-t 8 \
-v Y > ${workdir}/mchelper_manual.log
```
