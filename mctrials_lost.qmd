---
title: "Manual curation trials - the lost final TEs"
date: 2025-08-07
execute:
  warning: false
format:
  html:
    self-contained: true
    fig-height: 12
    fig-width: 12
    fig-format: png
    fig-dpi: 300
---


# Comparing results of different TEammo curators
When I did this I found that my curated final libraries where much smaller, ~ 50 %
Though I had in error removed sequences during the final library review, this problem remains
Now we will just focus on one - D.tristis to look at exactly why the two libs are different

## Run BLASTs between curated libraries

```{bash}
#| eval: false

dean="../../mctrials_data2/MCH_output/D.tristis/nanopore_D2/D.tristis_nanopore_D2_curated-TE-library.fa"
marta="../../data/final_libraries/D.tristis/D.tristis.TE_library.fasta"
species="D.tristis"
strain="nanopore_D2"
genome="/mnt/netapp2/Store_csgcyjgp/dean/data/RM2/D.tristis_nanopore_D2.fasta"
RM2_lib="../../mctrials_data2/MCH_output/D.tristis/nanopore_D2/nanopore_D2-clean_families.fa"
MCH_lib="../../mctrials_data2/MCH_output/D.tristis/nanopore_D2/curated_sequences_NR.fa"

mkdir -p results/mctrials2

# Make the blastdbs - they are output in same folder as the fasta input
conda activate MCHelper

makeblastdb -in ${marta} -dbtype "nucl"
makeblastdb -in ${dean} -dbtype "nucl"

makeblastdb -in ${RM2_lib} -dbtype "nucl" # we can try blasting againts the original RM2 to retrieve TE names
makeblastdb -in ${MCH_lib} -dbtype "nucl"

# Run BLASTS - reciprocal in case useful later?
blastn -query ${dean} -db ${marta} -outfmt 6 -max_hsps 1 -out results/mctrials2/${species}_${strain}_dean_vs_marta.blast.out
blastn -query ${marta} -db ${dean} -outfmt 6 -max_hsps 1 -out results/mctrials2/${species}_${strain}_marta_vs_dean.blast.out

# I noticed often 1 of my TEs has multiple high similarity hits to those in the db
# so do a self BLAST

blastn -query ${marta} -db ${marta} -outfmt 6 -max_hsps 1 -out results/mctrials2/${species}_${strain}_marta_vs_self.blast.out
blastn -query ${dean} -db ${dean} -outfmt 6 -max_hsps 1 -out results/mctrials2/${species}_${strain}_dean_vs_self.blast.out

# BLast martas against RM2 (clean) to retrieve original names because that metadata is lost 
blastn -query ${marta} -db ${RM2_lib} -outfmt 6 -max_hsps 1 -out results/mctrials2/${species}_${strain}_marta_vs_RM2.blast.out
blastn -query ${marta} -db ${MCH_lib} -outfmt 6 -max_hsps 1 -out results/mctrials2/${species}_${strain}_marta_vs_MCH.blast.out


```

```{bash}
lib1="../../mctrials_data2/MCH_output/D.tristis/nanopore_D2/D.tristis_nanopore_D2_curated-TE-library.fa"
marta="../../data/final_libraries/D.tristis/D.tristis.TE_library.fasta"
species="D.tristis"
strain="nanopore_D2"
genome="/mnt/netapp2/Store_csgcyjgp/dean/data/RM2/D.tristis_nanopore_D2.fasta"
RM2_lib="../../mctrials_data2/MCH_output/D.tristis/nanopore_D2/nanopore_D2-clean_families.fa"
MCH_lib="../../mctrials_data2/MCH_output/D.tristis/nanopore_D2/curated_sequences_NR.fa"
scripts/libcompare.sh 
```


## Visualisation
```{r}
#| output: false

if(!require("BiocManager", character.only = T)) install.packages("BiocManager")
pkgs.list <- readLines("r-requirements.txt")

for (i in 1:length(pkgs.list)){
  if(!require(pkgs.list[i], character.only = T)){
    BiocManager::install(pkgs.list[i], Ncpus = ceiling(parallel::detectCores()/1.7))
    require(pkgs.list[i], character.only = TRUE)
  }else{require(pkgs.list[1],character.only = TRUE)}
}
```


## Load and overall comparisons
```{r}
#| output: false
setwd("/home/csic/gcy/jgp/extra_storage/dean/mctrials/mctrials")
source("scripts/mccompare_functions.R")

# Color schemes

palette_seq_match <- c(
  "Missing from query lib" = "black",                     # Clear and bold
  "Missing from subject lib" = "grey50",                  # Distinct but neutral
  "Present, 70" = RColorBrewer::brewer.pal(1, "Greens")[1],  # Light green
  "Present, 80" = RColorBrewer::brewer.pal(2, "Greens")[2],  # Medium green
  "Perfect, 95-100" = RColorBrewer::brewer.pal(3, "Greens")[3]  # Bright green
)

# Load the TE classifications
teClassification <- read.table("orozco_classification-2024_mchelper.csv", sep = ";", header = TRUE)
teClassification <- teClassification %>%
  mutate(AppName = paste(Class, Order, Superfamily, sep ="/") %>% sub("/$", "", .) %>% sub("/$", "", .))
teClassification <- rbind(
  teClassification
  , c("", "Unclassified", "", "Unclassified")
)

# Load libraries to compare

# Drosophila tristis
lib_Dtri_marta <- teReadLib(
  "../../data/final_libraries/D.tristis/D.tristis.TE_library.fasta",
  libIdentifier = "Marta",
  species = "D.tristis", strain = "nanopore_D2")

lib_Dtri_dean <- teReadLib(
  "../../mctrials_data2/MCH_output/D.tristis/nanopore_D2/D.tristis_nanopore_D2_curated-TE-library.fa",
  libIdentifier = "Dean",
  species = "D.tristis", strain = "nanopore_D2")

lib_Dtri_RM2 <- teReadLib(
  "../../mctrials_data2/MCH_output/D.tristis/nanopore_D2/nanopore_D2-clean_families.fa",
  libIdentifier = "RM2",
  species = "D.tristis", strain = "nanopore_D2")

lib_Dtri_MCH <- teReadLib(
  "../../mctrials_data2/MCH_output/D.tristis/nanopore_D2/curated_sequences_NR.fa",
  libIdentifier = "MCH",
  species = "D.tristis", strain = "nanopore_D2")

# Load the names relation file from the TEammo output
names_relate_file = "../../mctrials_data2/MCH_output/D.tristis/nanopore_D2/MCH_final/D.tristis_nanopore_D2_TE-names-relation.tsv"

```

# Load BLAST results


```{r}
blast_Dtri_dean_vs_marta <- LoadBlastComparison(
  blast_out = "results/mctrials2/D.tristis_nanopore_D2_dean_vs_marta.blast.out",
  blast_query_lib = lib_Dtri_dean,
  blast_subject_lib = lib_Dtri_marta,
  species = "D.tristis",
  strain = "nanopore_D2",
  comparison = "dean_vs_marta")

blast_Dtri_marta_vs_dean <- LoadBlastComparison(
  blast_out = "results/mctrials2/D.tristis_nanopore_D2_marta_vs_dean.blast.out",
  blast_query_lib = lib_Dtri_marta,
  blast_subject_lib = lib_Dtri_dean,
  species = "D.tristis",
  strain = "nanopore_D2",
  comparison = "marta_vs_dean")

# load the self blasts
blast_Dtri_dean_vs_self <- LoadBlastComparison(
  blast_out = "results/mctrials2/D.tristis_nanopore_D2_dean_vs_self.blast.out",
  blast_query_lib = lib_Dtri_dean,
  blast_subject_lib = lib_Dtri_dean,
  species = "D.tristis",
  strain = "nanopore_D2",
  comparison = "dean_vs_self",
  reduce_hits = FALSE)

blast_Dtri_marta_vs_self <- LoadBlastComparison(
  blast_out = "results/mctrials2/D.tristis_nanopore_D2_marta_vs_self.blast.out",
  blast_query_lib = lib_Dtri_marta,
  blast_subject_lib = lib_Dtri_marta,
  species = "D.tristis",
  strain = "nanopore_D2",
  comparison = "marta_vs_self",
  reduce_hits = FALSE)


```

# Redundancy suspicion
Eyeballing the BLAST hits suggests that marta's final library is more redundant than mine...


```{r}
# Only works with non best hit blast
BlastSummaryStats <- function(blast, libIdentifier) {
  summary_stats <- blast %>%
    summarise(
      n_query_seqs = n_distinct(qseqid),
      n_hits_all = n(),
      n_self_hits = sum(qseqid == sseqid),
      n_nonself_hits_all = sum(qseqid != sseqid),
      n_nonself_hits_perfect = sum(qseqid != sseqid & seq_match_score == 4),
      n_nonself_hits_present80 = sum(qseqid != sseqid & seq_match_score == 3),
      n_nonself_hits_present70 = sum(qseqid != sseqid & seq_match_score == 2)
    ) %>%
    mutate(
      pct_self_hits = 100 * n_self_hits / n_hits_all,
      pct_nonself_hits_all = 100 * n_nonself_hits_all / n_hits_all,
      pct_nonself_hits_perfect = 100 * n_nonself_hits_perfect / n_hits_all,
      pct_nonself_hits_present80 = 100 * n_nonself_hits_present80 / n_hits_all,
      pct_nonself_hits_present70 = 100 * n_nonself_hits_present70 / n_hits_all
    )

    
    summary_stats$lib <- libIdentifier
    summary_stats
}

sum_blast_Dtri_dean_vs_self <- BlastSummaryStats(blast_Dtri_dean_vs_self, "Dtri_dean_vs_self")
sum_blast_Dtri_marta_vs_self <- BlastSummaryStats(blast_Dtri_marta_vs_self, "Dtri_marta_vs_self")

sum_blast_all <- bind_rows(
    sum_blast_Dtri_dean_vs_self,
    sum_blast_Dtri_marta_vs_self
)

gt(sum_blast_all)


```


```{r}
#| label: fig-bar-matches-Dtri
#| fig-height: 12
#| fig-cap: "TE query library (current curator, Dean) vs subject library (previous curator, Marta) by BLASTn hit totals (A), percent by TE classification (B), and by total quantites of TE consensuses missing from the query library (C), also shown as classification None/None/None in A & B. BLASTn hits of TE consensus library categorised by BLAST percent identity (pident): Perfect, 95-100 %; Present 80, 80-94 %; Present 70, 70-79 %; Missing, 69 % > - subdivided by missing from query or subject library"

PlotBlastBarMatches(blast_Dtri_dean_vs_marta)
```

# what about reciprocal?
Not useful really
```{r}
PlotBlastBarMatches(blast_Dtri_marta_vs_dean)

```


```{r}

source("scripts/mccompare_functions.R")

blast_Dtri_marta_vs_MCH <- LoadBlastComparison(
  blast_out = "results/mctrials2/D.tristis_nanopore_D2_marta_vs_MCH.blast.out",
  blast_query_lib = lib_Dtri_marta,
  blast_subject_lib = lib_Dtri_MCH,
  species = "D.tristis",
  strain = "nanopore_D2",
  comparison = "marta_vs_MCH")

lib_Dtri_MCH_names <- as.data.frame(names(lib_Dtri_MCH))

# Get the best hit which is the origninal name of the seq in the MCH lib
blast_Dtri_marta_vs_MCH <- blast_Dtri_marta_vs_MCH %>%
  group_by(qseqid) %>%
  slice_max(order_by = bitscore, n = 1, with_ties = FALSE) %>%
  ungroup()

names_relate_marta <- blast_Dtri_marta_vs_MCH %>%
  select(qseqid, sseqid) %>%
  filter(qseqid != "None")

colnames(names_relate_marta) <- c("newIDs", "seqID")

# Now get the names relate to convert the final names of MY lib into the orignial MCH ones - newIDs to seqID
names_relate <- data.table::fread(names_relate_file, sep = "\t") %>%
  select(seqID, newIDs)

# Now join in the original MCH names - seqID
blast_with_old_names <- blast_Dtri_marta_vs_dean %>%
  left_join(names_relate, by = c("sseqid" = "newIDs"))

# Now use MCH blast to identify sseqid in dean vs marta
blast_with_old_names <- blast_with_old_names %>%
  left_join(names_relate_marta, by = c("qseqid" = "newIDs"))

blast_with_old_names <-   blast_with_old_names %>%
  dplyr::rename(
    name_MCH = seqID.y,
    name_TEammo = seqID.x
  )

# Now reduce to only those I missed, with original name in the MCH library
missing_query <- blast_with_old_names %>%
  filter(
    seq_match == "Missing from subject lib"
  ) %>%
  select(name_MCH, name_TEammo)

not_missing_query <- blast_with_old_names %>%
  filter(
    seq_match != "Missing from query lib"
  ) %>%
  select(name_MCH, name_TEammo)

# OK - now what happened to these sequences?

presence_df1 <- checkSeqFate2(
  species = "D.tristis",
  strain = "nanopore_D2",
  MCH_output_dir = "../../mctrials_data2/MCH_output/",
  query_ids = missing_query)

summary_row1 <- colSums(presence_df1[, -1])
summary_row1 <- c(seqID = "TOTAL_PRESENT", summary_row1)


query_missing_fate2 <- data.frame(
  category = names(summary_row1),
  value = as.numeric(summary_row1)
)
query_missing_fate2


# Repeat for non-missing seqs

presence_df1 <- checkSeqFate2(
  species = "D.tristis",
  strain = "nanopore_D2",
  MCH_output_dir = "../../mctrials_data2/MCH_output/",
  query_ids = as.data.frame(not_missing_query))

summary_row1 <- colSums(presence_df1[, -1])
summary_row1 <- c(seqID = "TOTAL_PRESENT", summary_row1)


query_not_missing_fate2 <- data.frame(
  category = names(summary_row1),
  value = as.numeric(summary_row1)
)
query_not_missing_fate2

write.table(missing_query$name_MCH, "missing_query.csv", 
            sep = "\t",       # or " " for space-separated
            row.names = FALSE,
            col.names = FALSE,
            quote = FALSE)

# rnd-5_family-1661_s_1_unconfirmed
```

# Simpler version to double check
```{r}
blast_Dtri_marta_vs_MCH <- LoadBlastComparison(
  blast_out = "results/mctrials2/D.tristis_nanopore_D2_marta_vs_MCH.blast.out",
  blast_query_lib = lib_Dtri_marta,
  blast_subject_lib = lib_Dtri_MCH,
  species = "D.tristis",
  strain = "nanopore_D2",
  comparison = "marta_vs_MCH")

marta_MCH_names <- blast_Dtri_marta_vs_MCH %>%
      filter(qseqid != "None") %>%
      group_by(sseqid) %>%
      slice_max(order_by = bitscore, n = 1, with_ties = FALSE) %>%
      ungroup() %>%
  select(
    qseqid, sseqid
  ) %>%
  as.data.frame()

missing_from_dean <- blast_Dtri_marta_vs_dean %>%
  filter(
    seq_match == "Missing from subject lib") %>%
    select(qseqid) %>%
  as.data.frame()

missing_from_dean %>%
  left_join(marta_MCH_names, by = c("qseqid" = "qseqid"))

```
# The fate of the missing TEs
* My final lib was 49 vs Marta's 139 for this genome - of these 90 lost TEs:
  * 60 ended up in teNon80Lib - "complete_non808080.fa"
  * 2 ended up in teStandbyLib - presumably the 707070 bug meant they were not added
  * 28 ended up in teIncompleteModelsLib - "incomplete_non808080.fa"

## All the final lib seqs in Marta library are in the MCHelper library
All 139 have a blast hit 95-100% hit vs the MCHelper library
```{r}
length(lib_Dtri_marta)
length(unique(blast_Dtri_marta_vs_MCH$qseqid))

as.data.frame(table(blast_Dtri_marta_vs_MCH$seq_match))
```

## Did I discard them manually?
* 5 discarded in the first MI - they are in the discarded_sequences.fa so this was my manual inspection
* 28 discarded in the 808080 step
* 9 discarded in the Incomplete module
* 42 in total were discarded, leaving 48 removed somewhere else?

## Total seqs discarded?
* 57 in 808080
* 170 in incomplete
* 67 in first MI


# Where are the missing TEs?


```{bash}

conda activate bioinf
mkdir results/mctrials2/lost
find ../../mctrials_data2/MCH_output/D.tristis/nanopore_D2 -name "*.fa" -o -name "*.fasta" > all_fasta

for f in $(cat all_fasta); do
  seqkit grep --threads 4 -n -f missing_query.csv $f > results/mctrials/lost/${}


while IFS= read -r f; do
  count=$(seqkit grep -n -f missing_query.csv "$f" | grep -c "^>")
  echo "$f: $count matches"
done < all_fasta > lost_queries

```

## Curation of the lost seqs



```{bash}
MCH_lib="../../mctrials_data2/MCH_output/D.tristis/nanopore_D2/curated_sequences_NR.fa"

seqkit grep --threads 4 -n -f missing_query.csv $MCH_lib > results/mctrials2/lost/curated_sequences_NR.fa
cp -r ../../mctrials_data2 ../../mctrials_data3
cp results/mctrials2/lost/curated_sequences_NR.fa ../../mctrials_data3/MCH_output/D.tristis/nanopore_D2/curated_sequences_NR.fa
cp results/mctrials2/lost/curated_sequences_NR.fa ../../mctrials_data3/MCH_output/D.tristis/nanopore_D2/curated_sequences_R.fa

rm -fr ../../mctrials_data3/MCH_output/D.tristis/nanopore_D2/1_MI_MCH/2_MI_MCH/
rm -fr ../../mctrials_data3/MCH_output/D.tristis/nanopore_D2/1_MI_MCH/3_MI_MCH/
rm -fr ../../mctrials_data3/MCH_output/D.tristis/nanopore_D2/MCH_final/
```